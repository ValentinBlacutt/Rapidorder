<!-- Views/Admin/CrearHamburguesa.cshtml -->
@model Hamburguesa
@{
    ViewData["Title"] = "Crear Hamburguesa";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var ingredientes = ViewBag.Ingredientes as List<Ingrediente> ?? new List<Ingrediente>();
}

<div class="card">
    <div class="card-header">
        <h4 class="card-title mb-0">
            <i class="fas fa-plus me-2"></i>@ViewData["Title"]
        </h4>
    </div>
    <div class="card-body">
        <!-- Mostrar errores generales -->
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Mostrar errores de validación -->
        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Errores de validación:</h5>
                <ul>
                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                    {
                        <li>@error.ErrorMessage</li>
                    }
                </ul>
            </div>
        }

        <form method="post" asp-action="CrearHamburguesa" id="formHamburguesa" enctype="multipart/form-data">
            @Html.AntiForgeryToken()

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="Nombre" class="form-label">Nombre de la Hamburguesa *</label>
                        <input asp-for="Nombre" class="form-control" placeholder="Ej: Clásica, Doble Queso, Especial...">
                        <span asp-validation-for="Nombre" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="Precio" class="form-label">Precio (S/.) *</label>
                        <input asp-for="Precio" type="number" step="0.01" class="form-control" placeholder="0.00">
                        <span asp-validation-for="Precio" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Descripcion" class="form-label">Descripción</label>
                <textarea asp-for="Descripcion" class="form-control" rows="3"
                          placeholder="Describe los ingredientes principales y características..."></textarea>
                <span asp-validation-for="Descripcion" class="text-danger"></span>
            </div>

            <!-- Campo de carga de imagen -->
            <div class="mb-3">
                <label class="form-label">Imagen de la Hamburguesa</label>

                <!-- Vista previa de la imagen -->
                <div class="mb-3">
                    <img id="imagenPreview"
                         src="/images/hamburguesa-default.jpg"
                         alt="Vista previa"
                         class="img-thumbnail"
                         style="max-width: 300px; max-height: 300px; object-fit: cover;">
                </div>

                <!-- Selector de archivo -->
                <div class="input-group mb-2">
                    <input type="file"
                           class="form-control"
                           id="imagen"
                           name="imagen"
                           accept="image/jpeg,image/jpg,image/png,image/webp">
                    <button class="btn btn-outline-secondary" type="button" id="btnLimpiarImagen">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Formatos permitidos: JPG, PNG, WEBP. Tamaño máximo: 5MB
                </small>

                <!-- Campo oculto para URL manual (opcional) -->
                <div class="mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="usarUrlManual">
                        <label class="form-check-label" for="usarUrlManual">
                            Usar URL manual en lugar de cargar archivo
                        </label>
                    </div>
                    <input asp-for="ImagenUrl"
                           class="form-control mt-2"
                           id="imagenUrlInput"
                           placeholder="/images/hamburguesa-clasica.jpg"
                           style="display: none;">
                </div>
            </div>

            <hr class="my-4">

            <!-- SECCIÓN 1: Ingredientes INCLUIDOS -->
            <div class="mb-4">
                <label class="form-label fw-bold">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Ingredientes Incluidos (Base)
                </label>
                <p class="text-muted small mb-3">
                    Selecciona los ingredientes que vienen incluidos en el precio base de la hamburguesa.
                    Marca como obligatorios los que <strong>no se pueden quitar</strong>.
                </p>

                @if (ingredientes.Any())
                {
                    <div class="card border-success mb-4">
                        <div class="card-body">
                            <div class="row">
                                @for (int i = 0; i < ingredientes.Count; i++)
                                {
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-center justify-content-between p-2 border rounded">
                                            <div class="form-check flex-grow-1">
                                                <input class="form-check-input ingrediente-incluido"
                                                       type="checkbox"
                                                       name="ingredientesIncluidos"
                                                       value="@ingredientes[i].Id"
                                                       id="incluido_@ingredientes[i].Id">
                                                <label class="form-check-label" for="incluido_@ingredientes[i].Id">
                                                    <strong>@ingredientes[i].Nombre</strong>
                                                    @if (ingredientes[i].PrecioAdicional > 0)
                                                    {
                                                        <small class="text-muted">(+S/ @ingredientes[i].PrecioAdicional.ToString("0.00"))</small>
                                                    }
                                                </label>
                                            </div>
                                            <div class="form-check ms-2">
                                                <input class="form-check-input obligatorio-checkbox"
                                                       type="checkbox"
                                                       name="ingredientesObligatorios"
                                                       value="true"
                                                       data-ingrediente="@ingredientes[i].Id"
                                                       id="obligatorio_@ingredientes[i].Id"
                                                       disabled>
                                                <label class="form-check-label small text-nowrap" for="obligatorio_@ingredientes[i].Id">
                                                    <i class="fas fa-lock"></i> Obligatorio
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- SECCIÓN 2: Ingredientes EXTRAS -->
            <div class="mb-4">
                <label class="form-label fw-bold">
                    <i class="fas fa-plus-circle text-primary me-2"></i>
                    Ingredientes Extras Disponibles
                </label>
                <p class="text-muted small mb-3">
                    Selecciona los ingredientes que el cliente podrá <strong>agregar por un costo adicional</strong>.
                    Estos ingredientes NO vienen incluidos en la hamburguesa.
                </p>

                @if (ingredientes.Any())
                {
                    <div class="card border-primary">
                        <div class="card-body">
                            <div class="row">
                                @for (int i = 0; i < ingredientes.Count; i++)
                                {
                                    <div class="col-md-6 mb-2">
                                        <div class="form-check p-2 border rounded">
                                            <input class="form-check-input ingrediente-extra"
                                                   type="checkbox"
                                                   name="ingredientesExtras"
                                                   value="@ingredientes[i].Id"
                                                   id="extra_@ingredientes[i].Id">
                                            <label class="form-check-label d-flex justify-content-between align-items-center w-100"
                                                   for="extra_@ingredientes[i].Id">
                                                <span>
                                                    <strong>@ingredientes[i].Nombre</strong>
                                                </span>
                                                @if (ingredientes[i].PrecioAdicional > 0)
                                                {
                                                    <span class="badge bg-primary">+S/ @ingredientes[i].PrecioAdicional.ToString("0.00")</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Gratis</span>
                                                }
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No hay ingredientes disponibles.
                        <a href="/admin/ingredientes" class="alert-link">Crear ingredientes primero</a>.
                    </div>
                }
            </div>

            <hr class="my-4">

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save me-1"></i>Crear Hamburguesa
                </button>
                <a href="/admin/hamburguesas" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // === MANEJO DE IMAGEN ===
            const inputImagen = document.getElementById('imagen');
            const imagenPreview = document.getElementById('imagenPreview');
            const btnLimpiarImagen = document.getElementById('btnLimpiarImagen');
            const checkboxUrlManual = document.getElementById('usarUrlManual');
            const imagenUrlInput = document.getElementById('imagenUrlInput');

            // Vista previa de imagen al seleccionar archivo
            inputImagen.addEventListener('change', function(e) {
                const archivo = e.target.files[0];

                if (archivo) {
                    // Validar tamaño (5MB máximo)
                    if (archivo.size > 5 * 1024 * 1024) {
                        alert('La imagen es demasiado grande. El tamaño máximo es 5MB.');
                        inputImagen.value = '';
                        return;
                    }

                    // Validar tipo
                    const tiposPermitidos = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                    if (!tiposPermitidos.includes(archivo.type)) {
                        alert('Formato no permitido. Solo se aceptan JPG, PNG o WEBP.');
                        inputImagen.value = '';
                        return;
                    }

                    // Mostrar vista previa
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagenPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(archivo);
                }
            });

            // Limpiar imagen seleccionada
            btnLimpiarImagen.addEventListener('click', function() {
                inputImagen.value = '';
                imagenPreview.src = '/images/hamburguesa-default.jpg';
            });

            // Toggle entre carga de archivo y URL manual
            checkboxUrlManual.addEventListener('change', function() {
                if (this.checked) {
                    inputImagen.disabled = true;
                    btnLimpiarImagen.disabled = true;
                    imagenUrlInput.style.display = 'block';
                    imagenUrlInput.required = true;
                } else {
                    inputImagen.disabled = false;
                    btnLimpiarImagen.disabled = false;
                    imagenUrlInput.style.display = 'none';
                    imagenUrlInput.required = false;
                }
            });

            // Vista previa de URL manual
            imagenUrlInput.addEventListener('input', function() {
                if (this.value) {
                    imagenPreview.src = this.value;
                    imagenPreview.onerror = function() {
                        this.src = '/images/hamburguesa-default.jpg';
                    };
                }
            });

            // === INGREDIENTES INCLUIDOS ===
            const ingredientesIncluidos = document.querySelectorAll('.ingrediente-incluido');

            ingredientesIncluidos.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const ingredienteId = this.value;
                    const obligatorioCheckbox = document.querySelector(`.obligatorio-checkbox[data-ingrediente="${ingredienteId}"]`);
                    const extraCheckbox = document.getElementById(`extra_${ingredienteId}`);

                    if (this.checked) {
                        // Habilitar checkbox de obligatorio
                        obligatorioCheckbox.disabled = false;
                        obligatorioCheckbox.checked = true; // Por defecto marcar como obligatorio

                        // Deshabilitar en extras (no puede estar en ambos)
                        if (extraCheckbox) {
                            extraCheckbox.disabled = true;
                            extraCheckbox.checked = false;
                        }
                    } else {
                        // Deshabilitar y desmarcar obligatorio
                        obligatorioCheckbox.disabled = true;
                        obligatorioCheckbox.checked = false;

                        // Habilitar en extras
                        if (extraCheckbox) {
                            extraCheckbox.disabled = false;
                        }
                    }
                });
            });

            // === INGREDIENTES EXTRAS ===
            const ingredientesExtras = document.querySelectorAll('.ingrediente-extra');

            ingredientesExtras.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const ingredienteId = this.value;
                    const incluidoCheckbox = document.getElementById(`incluido_${ingredienteId}`);
                    const obligatorioCheckbox = document.querySelector(`.obligatorio-checkbox[data-ingrediente="${ingredienteId}"]`);

                    if (this.checked) {
                        // Deshabilitar en incluidos (no puede estar en ambos)
                        if (incluidoCheckbox) {
                            incluidoCheckbox.disabled = true;
                            incluidoCheckbox.checked = false;

                            // También deshabilitar el checkbox de obligatorio
                            if (obligatorioCheckbox) {
                                obligatorioCheckbox.disabled = true;
                                obligatorioCheckbox.checked = false;
                            }
                        }
                    } else {
                        // Habilitar en incluidos
                        if (incluidoCheckbox) {
                            incluidoCheckbox.disabled = false;
                        }
                    }
                });
            });

            // Validación antes de enviar
            document.getElementById('formHamburguesa').addEventListener('submit', function(e) {
                const algunIncluidoSeleccionado = Array.from(ingredientesIncluidos).some(cb => cb.checked);

                if (!algunIncluidoSeleccionado) {
                    e.preventDefault();
                    alert('Debes seleccionar al menos un ingrediente incluido para la hamburguesa.');
                    return false;
                }
            });
        });
    </script>
}